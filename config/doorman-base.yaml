external_components:
  - source: github://azoninc/doorman@${branch}
    refresh: 60s

# RMT Light Status LED Addon

light:
  - platform: esp32_rmt_led_strip
    id: doorman_rgb_status_led
    name: RGB Status LED
    icon: "mdi:led-on"
    internal: true
    restore_mode: ALWAYS_OFF
    rgb_order: GRB
    pin: ${rgb_led_pin}
    num_leds: 1
    chipset: ws2812
    use_psram: true
    rmt_symbols: 144
    gamma_correct: 1
    default_transition_length: 1s
    effects:
      - lambda:
          name: pulse
          update_interval: 250ms
          lambda: |-
            static bool on_ = false;

            auto call = id(doorman_rgb_status_led).make_call();
            
            call.set_state(true);
            call.set_color_mode_if_supported(light::ColorMode::RGB);

            float out = on_ ? (id(doorman_rgb_status_led_brightness).state / 100.0) : 0;
            call.set_brightness_if_supported(out);

            call.set_transition_length_if_supported(250);
            on_ = !on_;
            
            // don't tell HA every change
            call.set_publish(false);
            call.set_save(false);
            call.perform();

      - lambda:
          name: slow_pulse
          update_interval: 2s
          lambda: |-
            static bool on_ = false;

            auto call = id(doorman_rgb_status_led).make_call();
            
            call.set_state(true);
            call.set_color_mode_if_supported(light::ColorMode::RGB);

            float out = on_ ? (id(doorman_rgb_status_led_brightness).state / 100.0) : 0;
            call.set_brightness_if_supported(out);

            call.set_transition_length_if_supported(2500);
            on_ = !on_;
            
            // don't tell HA every change
            call.set_publish(false);
            call.set_save(false);
            call.perform();

      - lambda:
          name: ring_to_open
          update_interval: 2s
          lambda: |-
            static bool on_ = false;

            auto call = id(doorman_rgb_status_led).make_call();
            
            call.set_state(true);
            call.set_color_mode_if_supported(light::ColorMode::RGB);
            
            float out = on_ ? (id(doorman_rgb_status_led_brightness).state / 100.0) : 0;
            call.set_brightness_if_supported(out);

            call.set_transition_length_if_supported(4000);
            on_ = !on_;
            
            // don't tell HA every change
            call.set_publish(false);
            call.set_save(false);
            call.perform();

      - lambda:
          name: error_api
          update_interval: 1s
          lambda: |-
            static bool on_ = false;

            auto call = id(doorman_rgb_status_led).make_call();

            call.set_state(true);
            call.set_color_mode_if_supported(light::ColorMode::RGB);
            call.set_brightness_if_supported(id(doorman_rgb_status_led_brightness).state / 100.0);

            call.set_transition_length(1000);

            on_ = !on_;

            if (on_) {
              call.set_rgb(1.0, 0, 0);
            } else {
              call.set_rgb(0, 0.22, 1.0);
            }

            // don't tell HA every change
            call.set_publish(false);
            call.set_save(false);
            call.perform();
  - platform: status_led
    id: doorman_status_led
    name: Status LED
    icon: "mdi:led-on"
    pin: ${led_pin}
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_system
      sorting_weight: 1

  - platform: binary
    id: hallway_light
    device_id: tc_bus_general
    name: "Hallway Light"
    icon: mdi:lightbulb-on
    output: hallway_light_output
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_controls
      sorting_weight: 4


# Essential ESPHome Configuration Options
esphome:
  name_add_mac_suffix: false
  min_version: "2026.1.0"
  on_boot:
    - priority: 500.0
      then:
        - script.execute: boot_component_init
    - priority: 375.0
      then:
        # RGB status LED boot sequence
        - script.execute: boot_state
    - priority: 350.0
      then:
        - script.execute: set_unused_entities_internal

  devices:
    - id: tc_bus_general
      name: "TC:BUS"
    - id: tc_bus_is
      name: "TC:BUS Indoor Station"

# Enable logging
logger:
  id: esphome_logger
  level: ${log_level}
  initial_level: ${log_level}
  runtime_tag_levels: true


web_server:
  js_url: "https://doorman.azon.ai/firmware/esphome-webserver/www.js"
  version: 3
  sorting_groups:
    - id: sorting_group_controls
      name: "Quick Actions"
      sorting_weight: -100

    - id: sorting_group_setup_status
      name: "Setup"
      sorting_weight: -99

    - id: sorting_group_settings
      name: "Settings - TC:BUS General"
      sorting_weight: -90

    - id: sorting_group_indoor_station_settings
      name: "Settings - TC:BUS Indoor Station"
      sorting_weight: -70

    - id: sorting_group_settings_advanced
      name: "Settings - Advanced"
      sorting_weight: -69

    - id: sorting_group_system
      name: "Settings - System"
      sorting_weight: -50

    - id: sorting_group_listeners
      name: "Doorman Listeners"
      sorting_weight: -40

    - id: sorting_group_debug_tools
      name: "Debugging Tools"
      sorting_weight: -30

    - id: sorting_group_updates
      name: "Firmware Updates"
      sorting_weight: 0

    - id: sorting_group_information
      name: "Information - System"
      sorting_weight: -5

wifi:
  id: wifi_id

# Setup RMT components
remote_receiver:
  pin:
    number: ${rx_pin}
    mode:
      input: true
      pulldown: true
  filter: 1500us
  idle: 7000us

remote_transmitter:
  pin:
    number: ${tx_pin}
    mode: OUTPUT
  carrier_duty_percent: 100%
  eot_level: false
  non_blocking: true
  on_complete:
    - if:
        condition:
          - switch.is_on: doorman_status_led_bus_activity
        then:
          - script.execute: blink_status_led

# Setup TC:BUS Component
tc_bus:
  id: tc_bus_id
  on_telegram:
    - if:
        condition:
          - switch.is_on: doorman_status_led_bus_activity
        then:
          - script.execute: blink_status_led

# Setup TC:BUS Device Component
tc_bus_device:
  - id: tc_bus_indoor_station
    type: indoor_station
    auto_configuration: true

number:
  - platform: template
    id: doorman_rgb_status_led_brightness
    name: "Status LED: Brightness"
    icon: "mdi:brightness-7"
    mode : slider
    restore_value: true
    initial_value: '100'
    max_value: 100
    min_value: 10
    step: 1
    optimistic: true
    disabled_by_default: true
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_system
      sorting_weight: 2

  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_indoor_station
    serial_number:
      id: indoor_station_serial_number
      device_id: tc_bus_is
      name: "Serial Number"
      icon: "mdi:barcode-scan"
      #disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_indoor_station_settings
        sorting_weight: -100

  - platform: template
    id: entrance_door_station_address
    device_id: tc_bus_general
    name: "Entrance Station Address"
    icon: "mdi:counter"
    mode: box
    restore_value: true
    initial_value: '63'
    max_value: 63
    min_value: 0
    step: 1
    optimistic: true
    disabled_by_default: true
    entity_category: CONFIG
    on_value:
      - script.execute: set_unused_entities_internal
    web_server:
      sorting_group_id: sorting_group_settings
      sorting_weight: -99

  - platform: template
    id: second_entrance_door_station_address
    device_id: tc_bus_general
    name: "Second Entrance Station Address"
    icon: "mdi:counter"
    mode: box
    restore_value: true
    initial_value: '63'
    max_value: 63
    min_value: 0
    step: 1
    optimistic: true
    disabled_by_default: true
    entity_category: CONFIG
    on_value:
      - script.execute: set_unused_entities_internal
    web_server:
      sorting_group_id: sorting_group_settings
      sorting_weight: -98

text:
  - platform: template
    id: entrance_door_before_open_cmds
    device_id: tc_bus_general
    name: "Entrance Door Pre-Open-Telegrams"
    icon: "mdi:link-lock"
    optimistic: true
    min_length: 0
    max_length: 255
    mode: text
    restore_value: true
    initial_value : ""
    disabled_by_default: true
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_settings_advanced
      sorting_weight: -70

  - platform: template
    id: second_entrance_door_before_open_cmds
    device_id: tc_bus_general
    name: "Second Entrance Door Pre-Open-Telegrams"
    icon: "mdi:link-lock"
    optimistic: true
    min_length: 0
    max_length: 255
    mode: text
    restore_value: true
    initial_value : ""
    disabled_by_default: true
    entity_category: CONFIG
    web_server:
      sorting_group_id: sorting_group_settings_advanced
      sorting_weight: -69

text_sensor:
  - platform: hardware
    model:
      id: doorman_model
      name: "Model"
      icon: "mdi:package-variant"
      disabled_by_default: true
      entity_category: DIAGNOSTIC
      web_server:
        sorting_group_id: sorting_group_information
        sorting_weight: -20
    revision:
      id: doorman_revision
      name: "Revision"
      icon: "mdi:chip"
      disabled_by_default: true
      entity_category: DIAGNOSTIC
      web_server:
        sorting_group_id: sorting_group_information
        sorting_weight: -19

  - platform: tc_bus
    bus_telegram:
      id: last_bus_telegram
      device_id: tc_bus_general
      name: "Last Telegram"
      web_server:
        sorting_group_id: sorting_group_listeners
        sorting_weight: -99

  - platform: version
    id: esphome_version
    name: "ESPHome Version"
    icon: mdi:information-box
    hide_timestamp: true
    entity_category: DIAGNOSTIC
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_updates
      sorting_weight: 0

  - platform: template
    id: doorman_firmware_version
    name: "Doorman Version"
    icon: mdi:information-box
    lambda: |-
      return { ESPHOME_PROJECT_VERSION };
    entity_category: DIAGNOSTIC
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_updates
      sorting_weight: 1

switch:
  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_indoor_station
    force_long_door_opener_protocol:
      id: use_32_open_door_protocol
      device_id: tc_bus_is
      name: "Use 32-Bit Door Protocol"
      icon: mdi:flash-alert
      entity_category: CONFIG
      disabled_by_default: true
      web_server:
        sorting_group_id: sorting_group_settings_advanced
        sorting_weight: -50

  - platform: gpio
    id: doorman_relay
    name: "Relay"
    icon: mdi:electric-switch
    restore_mode: RESTORE_DEFAULT_OFF
    disabled_by_default: true
    pin: ${relay_pin}
    web_server:
      sorting_group_id: sorting_group_controls
      sorting_weight: 6

  - platform: template
    id: doorman_status_led_bus_activity
    name: "Status LED: Show Bus Activity"
    icon: "mdi:swap-vertical"
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: CONFIG
    disabled_by_default: true
    optimistic: true
    web_server:
      sorting_group_id: sorting_group_system
      sorting_weight: 3


output:
  - platform: template
    type: binary
    id: hallway_light_output
    write_action:
      - if:
          condition:
            lambda: !lambda return state;
          then:
            - tc_bus_device.send:
                id: tc_bus_indoor_station
                type: light
            - delay: 5s
            - light.turn_off: hallway_light

binary_sensor:
  - platform: gpio
    id: doorman_boot_button
    pin:
      number: GPIO0
      inverted: true
      mode:
        input: true
        pullup: true
      ignore_strapping_warning: true
    internal: true
    on_multi_click:
      # Single press
      - timing:
          - ON for at most 0.5s
          - OFF for at least 1.8s
        then:
          - event.trigger:
              id: doorman_boot_button_event
              event_type: single_press
      # Double press
      - timing:
          - ON for at most 0.5s
          - OFF for at most 1s
          - ON for at most 0.5s
          - OFF for at least 1.7s
        then:
          - event.trigger:
              id: doorman_boot_button_event
              event_type: double_press
      # Long press
      - timing:
          - ON for at least 5s
        then:
          - event.trigger:
              id: doorman_boot_button_event
              event_type: long_press

  - platform: gpio
    id: doorman_external_button
    pin:
      number: ${external_button_pin}
      mode:
        pullup: true
        input: true
      inverted: true
    internal: true
    on_multi_click:
      # Single press
      - timing:
          - ON for at most 0.5s
          - OFF for at least 1.8s
        then:
          - event.trigger:
              id: doorman_external_button_event
              event_type: single_press
      # Double press
      - timing:
          - ON for at most 0.5s
          - OFF for at most 1s
          - ON for at most 0.5s
          - OFF for at least 1.7s
        then:
          - event.trigger:
              id: doorman_external_button_event
              event_type: double_press
      # Long press
      - timing:
          - ON for at least 5s
        then:
          - event.trigger:
              id: doorman_external_button_event
              event_type: long_press

  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_indoor_station
    id: entrance_doorbell
    device_id: tc_bus_is
    name: "Entrance Doorbell"
    type: door_call
    address: !lambda "return id(entrance_door_station_address).state;"
    auto_off: 0.2s
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -28

  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_indoor_station
    id: second_entrance_doorbell
    device_id: tc_bus_is
    name: "Second Entrance Doorbell"
    type: door_call
    address: !lambda "return id(second_entrance_door_station_address).state;"
    auto_off: 0.2s
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -27

  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_indoor_station
    id: apartment_doorbell
    device_id: tc_bus_is
    name: "Apartment Doorbell"
    type: floor_call
    auto_off: 0.2s
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -29

  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_indoor_station
    id: pick_up_phone_door_call
    device_id: tc_bus_is
    name: "Pick up phone (door call)"
    icon: "mdi:phone-check"
    type: start_talking_door_call
    address: 255
    auto_off: 0.2s
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -19

  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_indoor_station
    id: hang_up_phone_door_call
    device_id: tc_bus_is
    name: "Hang up phone (door call)"
    icon: "mdi:phone-remove"
    type: stop_talking_door_call
    address: 255
    auto_off: 0.2s
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -18

  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_indoor_station
    id: pick_up_phone
    device_id: tc_bus_is
    name: "Pick up phone"
    icon: "mdi:phone-check"
    type: start_talking
    address: 255
    auto_off: 0.2s
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -17

  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_indoor_station
    id: hang_up_phone
    device_id: tc_bus_is
    name: "Hang up phone"
    icon: "mdi:phone-remove"
    type: stop_talking
    address: 255
    auto_off: 0.2s
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -16

  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_indoor_station
    id: function_button
    device_id: tc_bus_is
    name: "Function Button"
    icon: "mdi:circle-outline"
    auto_off: 0.2s
    type: control_function
    payload: 255
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -6

  - platform: tc_bus_device
    tc_bus_device_id: tc_bus_indoor_station
    id: light_button
    device_id: tc_bus_is
    name: "Light Button"
    icon: "mdi:white-balance-sunny"
    type: light
    auto_off: 0.2s
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -7

lock:
  - platform: tc_bus
    id: entrance_door
    device_id: tc_bus_general
    name: "Entrance Door"
    icon: mdi:door
    auto_lock: 5s
    address: !lambda "return id(entrance_door_station_address).state;"
    before_unlock_action:
      - if:
          condition:
            - lambda: return id(relay_mode)->current_option() == "Standalone";
          then:
            - script.execute:
                id: send_telegram_chain
                telegram_list: !lambda "return id(entrance_door_before_open_cmds).state;"
    after_unlock_action:
      # Turn on internal relay
      - if:
          condition:
            - lambda: return id(relay_mode)->current_option() == "Any Door Opener" || id(relay_mode)->current_option() == "Entrance Door Opener";
          then:
            - switch.turn_on: doorman_relay
    lock_action:
      # Turn off internal relay
      - if:
          condition:
            - lambda: return id(relay_mode)->current_option() == "Any Door Opener" || id(relay_mode)->current_option() == "Entrance Door Opener";
          then:
            - switch.turn_off: doorman_relay
    web_server:
      sorting_group_id: sorting_group_controls
      sorting_weight: 1

  - platform: tc_bus
    id: second_entrance_door
    device_id: tc_bus_general
    name: "Second Entrance Door"
    icon: mdi:door
    auto_lock: 5s
    address: !lambda "return id(second_entrance_door_station_address).state;"
    before_unlock_action:
      - if:
          condition:
            - lambda: return id(relay_mode)->current_option() == "Standalone";
          then:
            - script.execute:
                id: send_telegram_chain
                telegram_list: !lambda "return id(second_entrance_door_before_open_cmds).state;"
    after_unlock_action:
      # Turn on internal relay
      - if:
          condition:
            - lambda: return id(relay_mode)->current_option() == "Any Door Opener" || id(relay_mode)->current_option() == "Second Entrance Door Opener";
          then:
            - switch.turn_on: doorman_relay
    lock_action:
      # Turn off internal relay
      - if:
          condition:
            - lambda: return id(relay_mode)->current_option() == "Any Door Opener" || id(relay_mode)->current_option() == "Second Entrance Door Opener";
          then:
            - switch.turn_off: doorman_relay
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_controls
      sorting_weight: 2

select:
  - platform: template
    id: esphome_logger_level
    name: "ESPHome Log Level"
    icon: "mdi:math-log"
    optimistic: true
    options:
      - "Disabled"
      - "Error"
      - "Warning"
      - "Info"
    initial_option: "Info"
    restore_value: true
    entity_category: CONFIG
    on_value:
      - lambda: |-
          id(esphome_logger).set_log_level(i);
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_system
      sorting_weight: 5
      
  - platform: template
    id: relay_mode
    name: "Relay Mode"
    icon: "mdi:progress-star-four-points"
    optimistic: true
    options:
      - "Standalone"
      - "Entrance Door Opener"
      - "Second Entrance Door Opener"
      - "Any Door Opener"
    initial_option: "Standalone"
    restore_value: true
    entity_category: CONFIG
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_settings_advanced
      sorting_weight: -75

event:
  - platform: template
    id: entrance_doorbell_pattern
    device_id: tc_bus_is
    name: "Entrance Doorbell"
    icon: "mdi:doorbell"
    device_class: DOORBELL
    event_types:
      - "default"
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -30

  - platform: template
    id: second_entrance_doorbell_pattern
    device_id: tc_bus_is
    name: "Second Entrance Doorbell"
    icon: "mdi:doorbell"
    device_class: DOORBELL
    event_types:
      - "default"
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -40

  - platform: template
    id: apartment_doorbell_pattern
    device_id: tc_bus_is
    name: "Apartment Doorbell"
    icon: "mdi:doorbell"
    device_class: DOORBELL
    event_types:
      - "default"
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -50

  - platform: template
    id: phone_pick_up_pattern
    device_id: tc_bus_is
    name: "Phone pick up"
    icon: "mdi:phone-incoming-outgoing"
    event_types:
      - "default"
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: -20

  - platform: template
    id: doorman_boot_button_event
    name: "Flash Button"
    icon: "mdi:gesture-tap"
    device_class: BUTTON
    disabled_by_default: true
    event_types:
      - "single_press"
      - "double_press"
      - "long_press"
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: 100

  - platform: template
    id: doorman_external_button_event
    name: "External Button"
    icon: "mdi:gesture-tap"
    device_class: BUTTON
    event_types:
      - "single_press"
      - "double_press"
      - "long_press"
    disabled_by_default: true
    web_server:
      sorting_group_id: sorting_group_listeners
      sorting_weight: 99

script:
  - id: after_wifi_connection
    then:
      - logger.log: "Running after_wifi_connection script"

  - id: boot_component_init
    then:
      - logger.log: "Running boot_component_init script"

      # Always turn off relay on boot if not used standalone
      - if:
          condition:
            - lambda: return id(relay_mode)->current_option() != "Standalone";
          then:
            - switch.turn_off: doorman_relay

  - id: set_unused_entities_internal
    then:
      - logger.log: "Running set_unused_entities_internal script"

      # Set second entrance door internal if not used
      - lambda: |-
          bool internal = id(second_entrance_door_station_address).state == 63 || id(second_entrance_door_station_address).state == id(entrance_door_station_address).state;
          id(second_entrance_door)->set_internal(internal);
          id(second_entrance_door_before_open_cmds)->set_internal(internal);
          id(second_entrance_doorbell)->set_internal(internal);
          id(second_entrance_doorbell_pattern)->set_internal(internal);

  - id: blink_status_led
    mode: restart
    then:
      - light.turn_off: doorman_status_led
      - light.turn_on: doorman_status_led
      - delay: 100ms
      - light.turn_off: doorman_status_led

  - id: send_telegram_chain
    parameters:
      telegram_list: string
    then:
      - lambda: |-
          size_t start = 0;
          size_t end;

          while ((end = telegram_list.find(';', start)) != std::string::npos) {
              std::string token = telegram_list.substr(start, end - start);

              // Remove non-hex characters
              token.erase(std::remove_if(token.begin(), token.end(), [](char c) {
                  return !std::isxdigit(static_cast<unsigned char>(c));
              }), token.end());

              if (token.length() == 4 || token.length() == 8) {
                  const char* str = token.c_str();
                  char* endptr = nullptr;
                  errno = 0;  // Reset errno before call
                  unsigned long number = std::strtoul(str, &endptr, 16);

                  // Check if entire string was converted and no errors occurred
                  if (endptr == str + token.size() && errno == 0) {
                      if (token.length() == 8) {
                          id(tc_bus_id)->send_telegram(number, true);
                      } else {
                          id(tc_bus_id)->send_telegram(number);
                      }
                  }
              }
              start = end + 1;
          }

          // Handle last token
          std::string token = telegram_list.substr(start);
          token.erase(std::remove_if(token.begin(), token.end(), [](char c) {
              return !std::isxdigit(static_cast<unsigned char>(c));
          }), token.end());

          if (token.length() == 4 || token.length() == 8) {
              const char* str = token.c_str();
              char* endptr = nullptr;
              errno = 0;
              unsigned long number = std::strtoul(str, &endptr, 16);
              if (endptr == str + token.size() && errno == 0) {
                  if (token.length() == 8) {
                      id(tc_bus_id)->send_telegram(number, true);
                  } else {
                      id(tc_bus_id)->send_telegram(number);
                  }
              }
          }

  - id: boot_state
    then:
      # Boot Status LED
      - logger.log: "LED: Waiting for WiFi connection or provisioning"
      - light.turn_on:
          id: doorman_rgb_status_led
          effect: slow_pulse
          red: 100%
          green: 65%
          blue: 0%
      # Wait until wifi is connected or ap is active
      - wait_until:
          condition:
            - lambda: return id(wifi_id).is_connected() || id(wifi_id).is_ap_active();
      # Check if connected or AP active
      - if:
          condition: wifi.ap_active
          then:
            # AP active
            - logger.log: "LED: Waiting for WiFi configuration (AP Mode)"
            - light.turn_on:
                id: doorman_rgb_status_led
                effect: pulse
                red: 100%
                green: 65%
                blue: 0%
            # Wait until AP is deactivated
            - wait_until:
                condition:
                  - lambda: return id(wifi_id).is_ap_active() == false;
            - logger.log: "LED: Waiting for WiFi connection after AP"
            - light.turn_on:
                id: doorman_rgb_status_led
                effect: slow_pulse
                red: 100%
                green: 65%
                blue: 0%
            # Wait until wifi is really connected
            - wait_until:
                condition: wifi.connected
      # WiFi connected
      - logger.log: "LED: WiFi connected, waiting for API"

      - script.execute: after_wifi_connection

  - id: update_led
    then:
      - logger.log: "Conditionally set LED State"
      - light.turn_off:
          id: doorman_rgb_status_led
          transition_length: 1s
      # TODO: Restore specific state conditionally
      # Extended by addons
